name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  build-app:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: macos-14
    outputs:
      app_asset_name: ${{ steps.package.outputs.asset_name }}
      app_asset_sha256: ${{ steps.package.outputs.asset_sha256 }}
    steps:
      - uses: actions/checkout@v6

      - name: Build app bundle
        run: scripts/build-app-bundle.sh "${{ needs.release-please.outputs.tag_name }}" dist

      - name: Package app bundle
        id: package
        run: |
          TAG="${{ needs.release-please.outputs.tag_name }}"
          ASSET_NAME="hisohiso-${TAG}-darwin-arm64.zip"

          ditto -c -k --sequesterRsrc --keepParent dist/Hisohiso.app "dist/${ASSET_NAME}"

          SHA256="$(shasum -a 256 "dist/${ASSET_NAME}" | awk '{print $1}')"
          echo "asset_name=${ASSET_NAME}" >> "$GITHUB_OUTPUT"
          echo "asset_sha256=${SHA256}" >> "$GITHUB_OUTPUT"

      - name: Upload release app asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ needs.release-please.outputs.tag_name }}" \
            "dist/${{ steps.package.outputs.asset_name }}" \
            --clobber

  update-homebrew-tap:
    needs: [release-please, build-app]
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Homebrew tap
        uses: actions/checkout@v6
        with:
          repository: dungle-scrubs/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap
          fetch-depth: 0

      - name: Update formula and cask
        env:
          TAG: ${{ needs.release-please.outputs.tag_name }}
          APP_ASSET_NAME: ${{ needs.build-app.outputs.app_asset_name }}
          APP_ASSET_SHA256: ${{ needs.build-app.outputs.app_asset_sha256 }}
        run: |
          set -euo pipefail

          VERSION="${TAG#v}"
          SOURCE_URL="https://github.com/dungle-scrubs/hisohiso/archive/refs/tags/${TAG}.tar.gz"

          curl -fsSL -o source.tar.gz "${SOURCE_URL}"
          SOURCE_SHA256="$(shasum -a 256 source.tar.gz | awk '{print $1}')"

          perl -i -pe "s|url \".*\"|url \"${SOURCE_URL}\"|; s|sha256 \".*\"|sha256 \"${SOURCE_SHA256}\"|" homebrew-tap/Formula/hisohiso.rb

          mkdir -p homebrew-tap/Casks
          cat > homebrew-tap/Casks/hisohiso-app.rb <<EOF
          cask "hisohiso-app" do
            version "${VERSION}"
            sha256 "${APP_ASSET_SHA256}"

            url "https://github.com/dungle-scrubs/hisohiso/releases/download/v#{version}/${APP_ASSET_NAME}"
            name "Hisohiso"
            desc "Local-first macOS dictation app with multi-backend transcription"
            homepage "https://github.com/dungle-scrubs/hisohiso"

            depends_on macos: ">= :sonoma"
            depends_on arch: :arm64

            app "Hisohiso.app"
            binary "#{appdir}/Hisohiso.app/Contents/MacOS/Hisohiso", target: "hisohiso"
          end
          EOF

      - name: Commit, PR, and merge tap update
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG: ${{ needs.release-please.outputs.tag_name }}
        run: |
          cd homebrew-tap

          if [[ -z "$(git status --porcelain -- Formula/hisohiso.rb Casks/hisohiso-app.rb)" ]]; then
            echo "Tap already up to date for ${TAG}"
            exit 0
          fi

          git config user.name github-actions
          git config user.email github-actions@github.com

          BRANCH="chore/hisohiso-${TAG}"
          git checkout -B "${BRANCH}"
          git add Formula/hisohiso.rb Casks/hisohiso-app.rb
          git commit -m "chore: update hisohiso formula and cask to ${TAG}"
          git push --force-with-lease --set-upstream origin "${BRANCH}"

          PR_URL=$(gh pr create \
            --repo dungle-scrubs/homebrew-tap \
            --title "chore: update hisohiso formula and cask to ${TAG}" \
            --body "Auto-updates formula and cask for ${TAG}." \
            --base main \
            --head "${BRANCH}" \
            || gh pr view "${BRANCH}" --repo dungle-scrubs/homebrew-tap --json url -q .url)

          gh pr merge --repo dungle-scrubs/homebrew-tap "${PR_URL}" --squash --delete-branch
